<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</title>

  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      padding: 20px;
      background: #f5f5f5;
    }
    .card {
      max-width: 420px;
      margin: 0 auto;
      background: #fff;
      padding: 20px;
      border-radius: 16px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.06);
    }
    h2 {
      margin-top: 0;
    }
    .input-box {
      margin-bottom: 16px;
    }
    label {
      display: block;
      margin-bottom: 4px;
      font-size: 14px;
      color: #444;
    }
    input {
      width: 100%;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid #ccc;
      font-size: 14px;
      box-sizing: border-box;
    }
    button {
      background-color: #00c300;
      color: white;
      padding: 12px 16px;
      border: none;
      border-radius: 10px;
      width: 100%;
      font-size: 16px;
      cursor: pointer;
    }
    button:disabled {
      opacity: 0.6;
      cursor: default;
    }
    #result {
      margin-top: 16px;
      font-size: 14px;
    }
    #result.error {
      color: #d9534f;
    }
    #result.ok {
      color: #28a745;
    }
  </style>
</head>

<body>
  <div class="card">
    <h2>‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</h2>
    <p id="status" style="font-size:13px;color:#666;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å LINE...</p>

    <div class="input-box">
      <label>‡∏ä‡∏∑‡πà‡∏≠ ‚Äì ‡∏™‡∏Å‡∏∏‡∏•</label>
      <input id="name" type="text" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠" />
    </div>

    <div class="input-box">
      <label>‡∏≠‡∏µ‡πÄ‡∏°‡∏•</label>
      <input id="email" type="email" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏≠‡∏µ‡πÄ‡∏°‡∏•" />
    </div>

    <button id="registerBtn" disabled>‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</button>

    <p id="result"></p>
  </div>

  <script>
    // üîß ‡∏õ‡∏£‡∏±‡∏ö‡∏™‡∏≠‡∏á‡∏Ñ‡πà‡∏≤‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
    const API_URL = "https://commentary-annie-annex-theories.trycloudflare.com/webhook/register-user-v2";
    const LIFF_ID = "2008497266-PDJkB0Vm"; // <-- ‡πÉ‡∏™‡πà LIFF ID ‡∏à‡∏£‡∏¥‡∏á‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì

    let lineId = null;

    const statusEl  = document.getElementById("status");
    const resultEl  = document.getElementById("result");
    const btn       = document.getElementById("registerBtn");
    const nameInput = document.getElementById("name");
    const emailInput= document.getElementById("email");

    function setResult(message, isError = false) {
      resultEl.textContent = message;
      resultEl.className = "";
      if (isError) {
        resultEl.classList.add("error");
      } else {
        resultEl.classList.add("ok");
      }
    }

    async function initLiff() {
      try {
        statusEl.textContent = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö LIFF...";
        await liff.init({ liffId: LIFF_ID });

        if (!liff.isLoggedIn()) {
          statusEl.textContent = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö LINE...";
          liff.login();
          return;
        }

        const profile = await liff.getProfile();
        lineId = profile.userId;

        // auto-fill ‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏≤‡∏Å‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå LINE ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏Å‡∏£‡∏≠‡∏Å
        if (!nameInput.value) {
          nameInput.value = profile.displayName || "";
        }

        statusEl.textContent = "‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö LINE ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‚úî";
        btn.disabled = false;
      } catch (err) {
        console.error("LIFF init error:", err);
        statusEl.textContent = "‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö LIFF ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à";
        setResult("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö LIFF ‡πÑ‡∏î‡πâ: " + err, true);
      }
    }

    async function registerUser() {
      try {
        if (!lineId) {
          setResult("‡πÑ‡∏°‡πà‡∏û‡∏ö LINE ID ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏õ‡∏¥‡∏î‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á", true);
          return;
        }

        const name  = nameInput.value.trim();
        const email = emailInput.value.trim();

        if (!name || !email) {
          setResult("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡∏∞‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö", true);
          return;
        }

        btn.disabled = true;
        setResult("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô...", false);

        const body = { name, email, lineId };

        console.log("Sending to API:", body);

        const res = await fetch(API_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(body),
        });

        const text = await res.text();
        console.log("Raw response:", text);

        let data;
        try {
          data = JSON.parse(text);
        } catch (_) {
          data = { message: text || "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡∏à‡∏≤‡∏Å‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå" };
        }

        if (!res.ok) {
          setResult("API error: " + (data.message || res.status), true);
        } else {
          setResult(data.message || "‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!", false);
        }

        // ‡∏ñ‡πâ‡∏≤‡∏≠‡∏¢‡∏≤‡∏Å‡∏õ‡∏¥‡∏î LIFF ‡∏´‡∏•‡∏±‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à:
        // setTimeout(() => liff.closeWindow(), 1500);

      } catch (err) {
        console.error("registerUser error:", err);
        setResult("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + err, true);
      } finally {
        btn.disabled = false;
      }
    }

    btn.addEventListener("click", registerUser);
    initLiff();
  </script>
</body>
</html>
